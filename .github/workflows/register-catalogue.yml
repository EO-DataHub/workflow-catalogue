name: Register Catalogue

on:
  push:
    branches:
      - develop
    paths:
      - "catalogue/**"

concurrency:
  group: register-catalogue
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  register-catalogue:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Check out the repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 2

      - name: Install uv
        uses: astral-sh/setup-uv@e92bafb6253dcd438e0484186d7669ea7a8ca1cc # v6.4.3

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: 3.13

      - name: Install the project
        run: uv sync --frozen --all-extras --dev

      - name: Detect changed and deleted catalogue files
        id: changes
        run: |
          CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD -- 'catalogue/**/*.json' | (grep -v 'catalog.json' || true) | tr '\n' ' ')
          DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1...HEAD -- 'catalogue/**/*.json' | (grep -v 'catalog.json' || true))
          DELETED_IDS=""
          for f in $DELETED_FILES; do
            DELETED_IDS="$DELETED_IDS $(basename "$f" .json)"
          done
          DELETED_IDS=$(echo "$DELETED_IDS" | xargs)

          echo "changed_files=${CHANGED}" >> "$GITHUB_OUTPUT"
          echo "deleted_ids=${DELETED_IDS}" >> "$GITHUB_OUTPUT"

          if [ -z "$CHANGED" ] && [ -z "$DELETED_IDS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

          echo "Changed files: ${CHANGED}"
          echo "Deleted IDs: ${DELETED_IDS}"

      - name: Register and publish catalogue records
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          ARGS=""
          if [ -n "${{ steps.changes.outputs.changed_files }}" ]; then
            ARGS="$ARGS --files ${{ steps.changes.outputs.changed_files }}"
          fi
          if [ -n "${{ steps.changes.outputs.deleted_ids }}" ]; then
            ARGS="$ARGS --deleted-ids ${{ steps.changes.outputs.deleted_ids }}"
          fi
          uv run python scripts/register.py $ARGS
        env:
          WF_CATALOGUE_API_URL: ${{ vars.WF_CATALOGUE_API_URL }}
          EODH__BASE_URL: ${{ vars.EODH__BASE_URL }}
          EODH__REALM: ${{ vars.EODH__REALM }}
          EODH__USERNAME: ${{ secrets.EODH__USERNAME }}
          EODH__PASSWORD: '${{ secrets.EODH__PASSWORD }}'
          EODH__CLIENT_ID: ${{ secrets.EODH__CLIENT_ID }}
          EODH__WORKSPACE_SERVICES_ENDPOINT_PATH: ${{ vars.EODH__WORKSPACE_SERVICES_ENDPOINT_PATH }}
          EODH__ADES_ENDPOINT_PATH: ${{ vars.EODH__ADES_ENDPOINT_PATH }}
          EODH__WORKSPACE_NAME: ${{ vars.EODH__WORKSPACE_NAME }}
