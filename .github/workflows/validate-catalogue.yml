name: Validate Catalogue

on:
  pull_request:
    branches:
      - develop
    paths:
      - "catalogue/**"

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-catalogue:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Check out the repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@e92bafb6253dcd438e0484186d7669ea7a8ca1cc # v6.4.3

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: 3.13

      - name: Setup cwltool
        run: |
          sudo apt-get update
          sudo apt-get install -y cwltool

      - name: Install the project
        run: uv sync --frozen --all-extras --dev

      - name: Detect changed catalogue files
        id: changes
        run: |
          CHANGED=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- 'catalogue/**/*.json' | tr '\n' ' ')
          echo "changed_files=${CHANGED}" >> "$GITHUB_OUTPUT"
          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
          echo "Changed catalogue files: ${CHANGED}"

      - name: Validate catalogue schemas
        run: uv run wfc catalogue validate --catalogue-path catalogue

      - name: Validate STAC URLs and CWL links
        if: steps.changes.outputs.has_changes == 'true'
        run: uv run python scripts/validate_ci.py --files ${{ steps.changes.outputs.changed_files }}
